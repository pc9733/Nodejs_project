name: Canary Deployment

on:
  workflow_dispatch:
    inputs:
      traffic_percentage:
        description: 'Traffic percentage for canary (1-50)'
        required: true
        default: '10'
      image_tag:
        description: 'Image tag to deploy (leave empty for latest commit SHA)'
        required: false

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: practice-node-app
  EKS_CLUSTER_NAME: practice-node-app

jobs:
  canary-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Log in to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4

      - name: Configure kubeconfig for EKS
        run: aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}

      - name: Determine image tag
        id: image
        run: |
          if [ -n "${{ github.event.inputs.image_tag }}" ]; then
            IMAGE_TAG="${{ github.event.inputs.image_tag }}"
          else
            IMAGE_TAG="${{ github.sha }}"
          fi
          echo "image-tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "Using image tag: $IMAGE_TAG"

      - name: Create canary deployment
        run: |
          # Create canary deployment from main deployment
          kubectl get deployment practice-node-app -n practice-app -o yaml | \
            sed 's/practice-node-app/practice-node-app-canary/g' | \
            kubectl apply -f -
          
          # Update canary with new image
          kubectl set image deployment/practice-node-app-canary node-app=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.image.outputs.image-tag }} -n practice-app
          
          # Wait for canary to be ready
          kubectl rollout status deployment/practice-node-app-canary -n practice-app --timeout=300s

      - name: Update ingress for traffic splitting
        run: |
          TRAFFIC_PERCENTAGE=${{ github.event.inputs.traffic_percentage }}
          MAIN_TRAFFIC=$((100 - TRAFFIC_PERCENTAGE))
          
          # Patch ingress to split traffic
          kubectl patch ingress practice-node-app -n practice-app --type='json' -p='[
            {
              "op": "replace",
              "path": "/spec/rules/0/http/paths",
              "value": [
                {
                  "path": "/",
                  "pathType": "Prefix",
                  "backend": {
                    "service": {
                      "name": "practice-node-app-canary",
                      "port": {"number": 80}
                    }
                  },
                  "weight": '$TRAFFIC_PERCENTAGE'
                },
                {
                  "path": "/",
                  "pathType": "Prefix", 
                  "backend": {
                    "service": {
                      "name": "practice-node-app",
                      "port": {"number": 80}
                    }
                  },
                  "weight": '$MAIN_TRAFFIC'
                }
              ]
            }
          ]'
          
          echo "üöÄ Traffic split: $TRAFFIC_PERCENTAGE% canary, $MAIN_TRAFFIC% main"

      - name: Wait for traffic routing
        run: |
          echo "‚è≥ Waiting for traffic routing to take effect..."
          sleep 30

      - name: Get ALB URL
        id: alb
        run: |
          ALB_URL=$(kubectl get ingress practice-node-app -n practice-app -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "")
          echo "alb-url=$ALB_URL" >> $GITHUB_OUTPUT

      - name: Canary health check
        run: |
          ALB_URL="${{ steps.alb.outputs.alb-url }}"
          if [ -n "$ALB_URL" ]; then
            echo "üîç Testing canary deployment at $ALB_URL"
            
            # Test multiple requests to verify traffic splitting
            SUCCESS_COUNT=0
            for i in {1..20}; do
              if curl -f -s http://$ALB_URL/health > /dev/null; then
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              fi
              sleep 2
            done
            
            echo "‚úÖ Health check: $SUCCESS_COUNT/20 requests successful"
            
            if [ $SUCCESS_COUNT -lt 15 ]; then
              echo "‚ùå Canary health check failed"
              exit 1
            fi
          else
            echo "‚ö†Ô∏è No ALB URL available"
          fi

      - name: Monitor canary metrics
        run: |
          echo "üìä Monitoring canary deployment for 2 minutes..."
          
          for i in {1..12}; do
            echo "Check $i/12:"
            kubectl get pods -n practice-app -l app=practice-node-app-canary
            kubectl get pods -n practice-app -l app=practice-node-app
            echo "---"
            sleep 10
          done

      - name: Promote or rollback
        run: |
          echo "ü§î Canary deployment is running with ${{ github.event.inputs.traffic_percentage }}% traffic"
          echo "üìù Manual decision required:"
          echo "  - To promote: Run 'Promote Canary' workflow"
          echo "  - To rollback: Run 'Rollback Canary' workflow"
          echo ""
          echo "üåê Test at: ${{ steps.alb.outputs.alb-url }}"

  rollback-canary:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'rollback'
    needs: canary-deploy
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4

      - name: Configure kubeconfig for EKS
        run: aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}

      - name: Rollback canary
        run: |
          echo "üîÑ Rolling back canary deployment..."
          
          # Reset ingress to 100% main traffic
          kubectl patch ingress practice-node-app -n practice-app --type='json' -p='[
            {
              "op": "replace",
              "path": "/spec/rules/0/http/paths",
              "value": [
                {
                  "path": "/",
                  "pathType": "Prefix",
                  "backend": {
                    "service": {
                      "name": "practice-node-app",
                      "port": {"number": 80}
                    }
                  }
                }
              ]
            }
          ]'
          
          # Delete canary deployment
          kubectl delete deployment practice-node-app-canary -n practice-app
          
          echo "‚úÖ Canary rollback completed"

  promote-canary:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'promote'
    needs: canary-deploy
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4

      - name: Configure kubeconfig for EKS
        run: aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}

      - name: Promote canary
        run: |
          echo "üöÄ Promoting canary to main deployment..."
          
          # Update main deployment with canary image
          CANARY_IMAGE=$(kubectl get deployment practice-node-app-canary -n practice-app -o jsonpath='{.spec.template.spec.containers[0].image}')
          kubectl set image deployment/practice-node-app node-app=$CANARY_IMAGE -n practice-app
          
          # Wait for main deployment to update
          kubectl rollout status deployment/practice-node-app -n practice-app --timeout=300s
          
          # Reset ingress to 100% main traffic
          kubectl patch ingress practice-node-app -n practice-app --type='json' -p='[
            {
              "op": "replace",
              "path": "/spec/rules/0/http/paths",
              "value": [
                {
                  "path": "/",
                  "pathType": "Prefix",
                  "backend": {
                    "service": {
                      "name": "practice-node-app",
                      "port": {"number": 80}
                    }
                  }
                }
              ]
            }
          ]'
          
          # Delete canary deployment
          kubectl delete deployment practice-node-app-canary -n practice-app
          
          echo "‚úÖ Canary promotion completed"
